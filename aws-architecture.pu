@startuml
!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/General/Users.puml
!include AWSPuml/Groups/AWSCloud.puml
!include AWSPuml/Groups/Generic.puml
!include AWSPuml/NetworkingContentDelivery/CloudFront.puml
!include AWSPuml/Storage/SimpleStorageService.puml
!include AWSPuml/Compute/LambdaLambdaFunction.puml
!include AWSPuml/FrontEndWebMobile/Amplify.puml

title 結婚式写真アップロードアプリ - AWSアーキテクチャ

skinparam shadowing false
hide stereotype
skinparam linetype ortho

!procedure $stepnum($number) 
<back:royalblue><color:white><b> $number </b></color></back>
!endprocedure

rectangle "$UsersIMG()\nユーザー\n(モバイル/デスクトップ)" as users

' External Neon Database (outside AWS Cloud)
rectangle "🐘 Neon PostgreSQL\n外部クラウドDB\nサーバーレス Postgres" as neon #00E5FF

AWSCloudGroup(aws) {
    ' フロントエンド層
    rectangle "$CloudFrontIMG()\nAmazon CloudFront\n(Amplify自動設定)\nアセット配信・キャッシュ" as cloudfront

    rectangle "$AmplifyIMG()\nAWS Amplify\nNext.js 15 App Router\n• /api/upload\n• /api/photos\n• /api/debug-env\n• /api/migrate" as amplify

    ' ストレージ層
    rectangle "$SimpleStorageServiceIMG()\nAmazon S3\nshota-wedding-photos-bucket\n写真ストレージ" as s3
    ' セキュリティ層
    rectangle "$IdentityAccessManagementIMG()\nAWS IAM\nS3アクセス権限\n認証・認可" as iam
}

' Layout positioning
users -[hidden]down-> cloudfront
cloudfront -[hidden]down-> amplify
amplify -[hidden]down-> s3
neon -[hidden]right-> aws

' メインデータフロー
users --> amplify : $stepnum("1") Webアプリアクセス

' 写真アップロードフロー
users --> amplify : $stepnum("2") アップロードURL要求\n(/api/upload)
amplify --> s3 : 署名付きURL生成
users --> s3 : $stepnum("3") 直接アップロード

' メタデータフロー
users --> amplify : $stepnum("4") メタデータ保存\n(/api/photos)
amplify --> neon : Prisma経由で保存

' ギャラリー表示フロー
users --> amplify : $stepnum("5") 写真一覧取得\n(/api/photos)
amplify <-- neon : Prisma経由で写真リスト
users <-- amplify : $stepnum("6") ギャラリー表示
amplify <-- s3 : 画像取得（必要時）

' セキュリティ・権限フロー
iam -.-> amplify : S3アクセス認証情報
iam -.-> s3 : アクセス権限

' 主要コンポーネント概要
note top of cloudfront
<b>結婚式写真アップロードアプリ</b>
・Next.js 15 App Router + Tailwind CSS
・Amplify内のAPI Routes
・Instagramスタイルギャラリー
・モバイルファースト設計
end note

note right of neon
<b>データベーススキーマ (Prisma)</b>
photosテーブル:
・id, nickname, comment
・s3Key, cloudFrontUrl
・uploadedAt
end note

note bottom of s3
<b>ストレージ</b>
・プライベートS3バケット
・署名付きURLアップロード
・CloudFront CDN
・/photos/{timestamp}-{filename}
end note

@enduml