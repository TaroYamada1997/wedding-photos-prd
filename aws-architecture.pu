@startuml
!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v14.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/General/Users.puml
!include AWSPuml/Groups/AWSCloud.puml
!include AWSPuml/Groups/Generic.puml
!include AWSPuml/NetworkingContentDelivery/CloudFront.puml
!include AWSPuml/Storage/SimpleStorageService.puml
!include AWSPuml/Compute/LambdaLambdaFunction.puml
!include AWSPuml/FrontEndWebMobile/Amplify.puml

title çµå©šå¼å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ—ãƒª - AWSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

skinparam shadowing false
hide stereotype
skinparam linetype ortho

!procedure $stepnum($number) 
<back:royalblue><color:white><b> $number </b></color></back>
!endprocedure

rectangle "$UsersIMG()\nãƒ¦ãƒ¼ã‚¶ãƒ¼\n(ãƒ¢ãƒã‚¤ãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—)" as users

' External Neon Database (outside AWS Cloud)
rectangle "ğŸ˜ Neon PostgreSQL\nå¤–éƒ¨ã‚¯ãƒ©ã‚¦ãƒ‰DB\nã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ Postgres" as neon #00E5FF

AWSCloudGroup(aws) {
    ' ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤
    rectangle "$CloudFrontIMG()\nAmazon CloudFront\n(Amplifyè‡ªå‹•è¨­å®š)\nã‚¢ã‚»ãƒƒãƒˆé…ä¿¡ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥" as cloudfront

    rectangle "$AmplifyIMG()\nAWS Amplify\nNext.js 15 App Router\nâ€¢ /api/upload\nâ€¢ /api/photos\nâ€¢ /api/debug-env\nâ€¢ /api/migrate" as amplify

    ' ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤
    rectangle "$SimpleStorageServiceIMG()\nAmazon S3\nshota-wedding-photos-bucket\nå†™çœŸã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸" as s3
    ' ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å±¤
    rectangle "$IdentityAccessManagementIMG()\nAWS IAM\nS3ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™\nèªè¨¼ãƒ»èªå¯" as iam
}

' Layout positioning
users -[hidden]down-> cloudfront
cloudfront -[hidden]down-> amplify
amplify -[hidden]down-> s3
neon -[hidden]right-> aws

' ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
users --> amplify : $stepnum("1") Webã‚¢ãƒ—ãƒªã‚¢ã‚¯ã‚»ã‚¹

' å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼
users --> amplify : $stepnum("2") ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLè¦æ±‚\n(/api/upload)
amplify --> s3 : ç½²åä»˜ãURLç”Ÿæˆ
users --> s3 : $stepnum("3") ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

' ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
users --> amplify : $stepnum("4") ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜\n(/api/photos)
amplify --> neon : PrismaçµŒç”±ã§ä¿å­˜

' ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤ºãƒ•ãƒ­ãƒ¼
users --> amplify : $stepnum("5") å†™çœŸä¸€è¦§å–å¾—\n(/api/photos)
amplify <-- neon : PrismaçµŒç”±ã§å†™çœŸãƒªã‚¹ãƒˆ
users <-- amplify : $stepnum("6") ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º
amplify <-- s3 : ç”»åƒå–å¾—ï¼ˆå¿…è¦æ™‚ï¼‰

' ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æ¨©é™ãƒ•ãƒ­ãƒ¼
iam -.-> amplify : S3ã‚¢ã‚¯ã‚»ã‚¹èªè¨¼æƒ…å ±
iam -.-> s3 : ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™

' ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¦‚è¦
note top of cloudfront
<b>çµå©šå¼å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ—ãƒª</b>
ãƒ»Next.js 15 App Router + Tailwind CSS
ãƒ»Amplifyå†…ã®API Routes
ãƒ»Instagramã‚¹ã‚¿ã‚¤ãƒ«ã‚®ãƒ£ãƒ©ãƒªãƒ¼
ãƒ»ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆè¨­è¨ˆ
end note

note right of neon
<b>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ (Prisma)</b>
photosãƒ†ãƒ¼ãƒ–ãƒ«:
ãƒ»id, nickname, comment
ãƒ»s3Key, cloudFrontUrl
ãƒ»uploadedAt
end note

note bottom of s3
<b>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</b>
ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆS3ãƒã‚±ãƒƒãƒˆ
ãƒ»ç½²åä»˜ãURLã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
ãƒ»CloudFront CDN
ãƒ»/photos/{timestamp}-{filename}
end note

@enduml